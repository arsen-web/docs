### **Репликация**
Репликация — одна из техник масштабирования баз данных. 
Состоит эта техника в том, что данные с одного сервера базы данных постоянно копируются (реплицируются) на один или несколько других (называемые репликами). 
Для (приложения, сайта) появляется возможность использовать не один сервер для обработки всех запросов, а несколько.
Таким образом появляется возможность распределить нагрузку с одного сервера на несколько.

![mountains](./img/replication1.png)
***

### **Существует два основных подхода при работе с репликацией данных:**
* Репликация Master-Slave;
* Репликация Master-Master.
***

### **Master-Slave репликация** <br />
В этом подходе выделяется один основной сервер базы данных, который называется Мастером.
На нем происходят все изменения в данных (любые запросы MySQL INSERT/UPDATE/DELETE).
Slave сервер постоянно копирует все изменения с Мастера.
С (приложения, сайта) на Slave сервер отправляются запросы чтения данных (запросы SELECT). 
Таким образом Мастер сервер отвечает за изменения данных, а Slave за чтение.

![mountains](./img/replication2.png)
<br /><br />
#### Несколько Слейвов
Преимущество этого типа репликации в том, что Вы можете использовать более одного Слейва. 
Обычно следует использовать не более 20 Слейв серверов при работе с одним Мастером.
<br /><br />
#### Задержка репликации
Асинхронность репликации означает, что данные на Слейве могут появится с небольшой задержкой. 
Поэтому, в последовательных операциях необходимо использовать чтение с Мастера, чтобы получить актуальные данные.
<br /><br />
#### Выход из строя
При выходе из строя Слейва, достаточно просто переключить все приложение на работу с Мастером. 
После этого восстановить репликацию на Слейве и снова его запустить.

Если выходит из строя Мастер, нужно переключить все операции (и чтения и записи) на Слейв.
Таким образом он станет новым Мастером. После восстановления старого Мастера, настроить на нем реплику, и он станет новым Слейвом.
<br /><br />
#### Резервирование
Намного чаще репликацию Master-Slave используют не для масштабирования, а для резервирования.
В этом случае, Мастер сервер обрабатывает все запросы от приложения.
Слейв сервер работает в пассивном режиме.
Но в случае выхода из строя Мастера, все операции переключаются на Слейв.
***


### **Master-Master репликация** <br />
В этом подходе любой из серверов может использоваться как для чтения (SELECT) так и для записи (INSERT/UPDATE/DELETE):
Master-Master репликация в MySQL используется распределения нагрузки на базу данных между несколькими серверами.
Хотя Master-Slave репликация намного популярнее и проще, Master-Master репликация может быть полезной.

![mountains](./img/replication5.png)
<br /><br />
#### Выход из строя
Вероятные поломки делают Master-Master репликацию непривлекательной.
Выход из строя одного из серверов практически всегда приводит к потере каких-то данных.
Последующее восстановление также сильно затрудняется необходимостью ручного анализа данных, которые успели либо не успели скопироваться.

Используйте Master-Master репликацию только в крайнем случае.
Вместо нее лучше пользоваться техникой "ручной" репликации, описанной ниже.
<br /><br />
#### Асинхронность репликации
В MySQL репликация работает в асинхронном режиме. 
Это значит, что приложение не знает, как быстро данные появятся на Слейве.
Задержка в репликации (replication lag) может быть как очень маленькой, так и очень большой.
Обычно рост задержки говорит о том, что сервера не справляются с текущей нагрузкой и их необходимо масштабировать дальше, например техниками горизонтального и вертикального шардинга.
<br /><br />
#### Синхронный режим
Синхронный режим репликации позволит гарантировать копирование данных на Слейв.
Это упростит работу в приложении, т.к. все операции чтения можно будет всегда отправлять на Слейв.
Однако это может значительно уменьшить скорость работы MySQL.
Синхронный режим не следует использовать в Web приложениях.
<br /><br />
#### "Ручная" репликация
Следует помнить, что репликация — это не технология, а методика. Встроенные механизмы репликации могут принести ненужные усложнения либо не иметь какой-то нужной функции. Некоторые технологии вообще не имеют встроенной репликации.

В таких случаях, следует использовать самостоятельную реализацию репликации.
В самом простом случае, приложение будет дублировать все запросы сразу на несколько серверов базы данных.

При записи данных, все запросы будут отправляться на несколько серверов.
Зато операции чтения можно будет отправлять на любой сервер.
Нагрузка при этом будет распределяться по всем доступным серверам.
Это позволит использовать преимущества репликации даже если сама технология ее не поддерживает.
<br /><br />
#### Выход из строя
При поломке одного из серверов в такой схеме необходимо сделать следующее:
* Исключить сервер из списка используемых.
* Настроить репликацию Master-Slave на новом сервере, используя один из рабочих серверов в качестве Мастера.
* Когда все данные репликации будут синхронизированы, включить сервер обратно в список используемых и остановить репликацию.
***

### **Итог** <br />
Репликация Master-Master используется в большей мере для резервирования баз данных и в меньшей для масштабирования.
Master-Slave репликация удобна для распределения запросов чтения по нескольким серверам.
Подход ручной репликации позволит использовать преимущества репликации для технологий, которые ее не поддерживают.
Зачастую репликация используется вместе с шардингом (Шардинг — это прием, который позволяет распределять данные между разными физическими серверами) при решении вопросов масштабирования.
 
### **MySql команды репликации:** <br />
`START SLAVE;` - Запустить репликацию <br />
`STOP SLAVE;` - Оставновить репликацию <br />
`SHOW SLAVE STATUS\G;` - Показать статус SLAVE сервера <br />
`SHOW MASTER STATUS\G;` - Показать статус MASTER сервера<br />
`RESET SLAVE;` - Сброс настроек репликации <br />
***
